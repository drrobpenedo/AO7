<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ETHRYX • EMASAI — Ethereal 5D Cloud</title>
<style>
  :root{
    --bg:#07090d; --panel:#0e1320; --text:#e8eef6; --muted:#9aa7b4;
    --accent:#5dd3ff; --accent2:#ffd166; --alpha:#ff4d4d; --omega:#4da6ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:radial-gradient(1400px 900px at 15% -10%,#142035 0%,#07090d 55%) fixed;
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow:hidden;
  }

  /* Top bar */
  header{
    position:fixed; inset:0 0 auto 0; height:48px; display:flex; align-items:center; gap:12px;
    padding:0 14px; background:linear-gradient(180deg,rgba(8,10,16,.55),rgba(8,10,16,.12));
    border-bottom:1px solid rgba(255,255,255,.06); backdrop-filter: blur(6px); z-index:20;
  }
  header h1{margin:0;font-size:15px; letter-spacing:.2px; font-weight:600; opacity:.95}
  .brand-tag{margin-left:auto; color:#ff3b3b; font-weight:800; letter-spacing:.6px; text-shadow:0 0 8px rgba(255,0,0,.55)}

  /* Stage */
  #stage{position:fixed; inset:0; display:grid; place-items:center;}
  canvas{width:100vw; height:100vh; display:block; background:transparent;}

  /* HUD */
  #hud{
    position:fixed; left:50%; transform:translateX(-50%);
    width:min(1100px,92vw); z-index:21; transition:opacity .25s, transform .25s;
  }
  #hud.bottom{bottom:10px;}  /* default dock */
  #hud.top{top:58px;}        /* dock under header */
  #hud.hidden{opacity:0; pointer-events:none;}

  #hud.compact .panel{display:none;}
  #hud.compact .dock{display:flex;}
  #hud.expanded .panel{display:grid;}
  #hud.expanded .dock{display:none;}

  .dock{
    align-items:center; justify-content:center; gap:8px;
    background:rgba(16,20,29,.7); border:1px solid #1a2233; border-radius:12px;
    padding:8px 12px; box-shadow:0 8px 26px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: blur(8px);
  }
  .dock button{border:1px solid #2a3650; background:#0f1726; color:var(--text); border-radius:8px; padding:8px 10px; cursor:pointer}
  .drag-handle{cursor:grab; color:var(--muted); font-size:12px}

  .panel{
    grid-template-columns: repeat(12, minmax(0,1fr)); gap:8px;
    background:rgba(16,20,29,.72); border:1px solid #1a2233; border-radius:12px;
    padding:10px; box-shadow:0 8px 26px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: blur(8px);
  }
  .card{background:rgba(10,14,22,.55); border:1px solid #1a2233; border-radius:10px; padding:8px 10px;}
  .title{font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type="range"]{width:100%}
  .btn{width:100%; padding:9px 10px; border-radius:9px; border:1px solid #2a3650; background:#0f1726; color:var(--text); cursor:pointer}
  .btn:hover{border-color:#334468}
  .preset-grid{display:grid; grid-template-columns: repeat(7,minmax(0,1fr)); gap:8px}

  @media (max-width:860px){
    .panel{grid-template-columns: repeat(2,minmax(0,1fr));}
    .preset-grid{grid-template-columns: repeat(3,minmax(0,1fr))}
  }
</style>
</head>
<body>
<header>
  <h1>Safe travel in the Ethereal 5D Cloud — <span style="opacity:.8">Ethryx / EMASAI</span></h1>
  <div class="brand-tag">ETHRYX-Data-Cloud</div>
</header>

<div id="stage"><canvas id="c"></canvas></div>

<!-- HUD -->
<section id="hud" class="bottom compact">
  <!-- compact dock -->
  <div class="dock">
    <span class="drag-handle" id="drag">⇅ drag</span>
    <button id="expand" class="btn" style="width:auto">▲ Expand controls</button>
  </div>

  <!-- full panel -->
  <div class="panel">
    <div class="card" style="grid-column: span 3">
      <div class="title">Focus speed</div>
      <input id="speed" type="range" min="0" max="1" step="0.001" value="0.36"/>
    </div>
    <div class="card" style="grid-column: span 3">
      <div class="title">Collapse radius</div>
      <input id="radius" type="range" min="0.4" max="4.0" step="0.01" value="1.35"/>
    </div>
    <div class="card" style="grid-column: span 3">
      <div class="title">Points</div>
      <input id="points" type="range" min="300" max="5000" step="50" value="1800"/>
    </div>
    <div class="card" style="grid-column: span 3">
      <button id="export" class="btn">⬇️ Export WebM</button>
      <div style="display:grid;gap:6px;margin-top:8px">
        <label style="font-size:12px;color:var(--muted)"><input id="showAxes" type="checkbox" checked/> Show Alpha/Omega axes</label>
        <label style="font-size:12px;color:var(--muted)"><input id="secure" type="checkbox" checked/> Secure Transit Trails</label>
      </div>
    </div>

    <div class="card" style="grid-column: span 6">
      <div class="title">Explorations</div>
      <div class="preset-grid">
        <button class="btn" id="pOrbit">Orbit</button>
        <button class="btn" id="pVortex">Vortex</button>
        <button class="btn" id="pPulse">Radius Pulse</button>
        <button class="btn" id="pAlpha">Alpha Sweep</button>
        <button class="btn" id="pOmega">Omega Sweep</button>
        <button class="btn" id="pBurst">Burst</button>
        <button class="btn" id="pAuto">Auto Demo</button>
      </div>
    </div>

    <div class="card" style="grid-column: span 6">
      <div class="title">Interaction</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <div class="title">Burst strength</div>
          <input id="burst" type="range" min="0" max="1" step="0.01" value="0.7"/>
        </div>
        <div>
          <div class="title">Density threshold</div>
          <input id="dens" type="range" min="40" max="500" step="5" value="150"/>
        </div>
      </div>
    </div>

    <div style="grid-column:1/-1; display:flex; justify-content:center; gap:10px; margin-top:2px">
      <button id="collapse" class="btn" style="width:auto">▼ Collapse</button>
    </div>
  </div>
</section>

<script>
/* ---------- utilities ---------- */
function mulberry32(seed){let t=seed>>>0;return function(){t|=0;t=(t+0x6D2B79F5)|0;let r=Math.imul(t^(t>>>15),1|t);r=(r+Math.imul(r^(r>>>7),61|r))^r;return((r^(r>>>14))>>>0)/4294967296;}}
function randn(rng){const u=Math.max(rng(),1e-12),v=rng();return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}
function gaussian(rng,mu=0,sigma=1){return mu+sigma*randn(rng);}

/* ---------- canvas & domain ---------- */
const DOMAIN={xmin:-5,xmax:6,ymin:-3,ymax:4};
const canvas=document.getElementById('c'); const ctx=canvas.getContext('2d');
let W=innerWidth, H=innerHeight, DPR=Math.min(devicePixelRatio||1,2), SCALE=1,MARGINX=0,MARGINY=0;
function fit(){W=innerWidth; H=innerHeight; canvas.width=W*DPR; canvas.height=H*DPR; ctx.setTransform(DPR,0,0,DPR,0,0);
  const sx=W/(DOMAIN.xmax-DOMAIN.xmin), sy=H/(DOMAIN.ymax-DOMAIN.ymin); SCALE=Math.min(sx,sy);
  const plotW=(DOMAIN.xmax-DOMAIN.xmin)*SCALE, plotH=(DOMAIN.ymax-DOMAIN.ymin)*SCALE; MARGINX=(W-plotW)/2; MARGINY=(H-plotH)/2;}
function toPX(x,y){return [MARGINX+(x-DOMAIN.xmin)*SCALE, H-(MARGINY+(y-DOMAIN.ymin)*SCALE)];}
addEventListener('resize',fit); fit();

/* ---------- field ---------- */
const DEFAULTS={centers:[{x:0,y:0,sigma:0.8,w:0.45},{x:4,y:1.6,sigma:0.65,w:0.35},{x:-3,y:2.4,sigma:1.0,w:0.20}]};
let rng=mulberry32(42), points=[];
function makePoints(n=1800){points.length=0;const w=DEFAULTS.centers.map(c=>c.w);const cdf=[];let acc=0;for(const wi of w){acc+=wi;cdf.push(acc);}
  for(let i=0;i<n;i++){const r=rng();const k=cdf.findIndex(v=>r<=v), c=DEFAULTS.centers[k];
    points.push({x:gaussian(rng,c.x,c.sigma),y:gaussian(rng,c.y,c.sigma),vx:0,vy:0,lastFx:null,lastFy:null,trail:0});}}
makePoints();

/* ---------- state & DOM ---------- */
let t=0, playing=true, mode='orbit', autoTimer=null, burstTimer=0;
const speed=document.getElementById('speed'), radius=document.getElementById('radius');
const pointsEl=document.getElementById('points'), burstEl=document.getElementById('burst'), densEl=document.getElementById('dens');
const showAxesEl=document.getElementById('showAxes'), secureEl=document.getElementById('secure');
document.getElementById('pOrbit').onclick=()=>setMode('orbit');
document.getElementById('pVortex').onclick=()=>setMode('vortex');
document.getElementById('pPulse').onclick=()=>setMode('pulse');
document.getElementById('pAlpha').onclick=()=>setMode('alpha');
document.getElementById('pOmega').onclick=()=>setMode('omega');
document.getElementById('pBurst').onclick=()=>{burstTimer=Math.max(burstTimer,0.7);};
document.getElementById('pAuto').onclick=()=>auto();
document.getElementById('export').onclick=record;
pointsEl.oninput=e=>makePoints(e.target.value|0);
document.addEventListener('keydown',e=>{if(e.key===' '){playing=!playing; e.preventDefault();}});

/* ---------- HUD expand/collapse + autohide + drag dock ---------- */
const hud=document.getElementById('hud'), expandBtn=document.getElementById('expand'), collapseBtn=document.getElementById('collapse'), drag=document.getElementById('drag');
let hideTimer=null;
function showHUD(){hud.classList.remove('hidden'); resetHide();}
function resetHide(){if(hud.classList.contains('compact')) return; if(hideTimer) clearTimeout(hideTimer); hideTimer=setTimeout(()=>hud.classList.add('hidden'), 4000);}
function expandHUD(){hud.classList.remove('compact'); hud.classList.add('expanded'); showHUD(); expandBtn.blur();}
function collapseHUD(){hud.classList.add('compact'); hud.classList.remove('expanded'); hud.classList.remove('hidden');}
expandBtn.onclick=expandHUD; collapseBtn.onclick=collapseHUD;
['mousemove','touchstart','touchmove','wheel','keydown','click','input'].forEach(ev=>document.addEventListener(ev,()=>showHUD(),{passive:true}));
hud.addEventListener('transitionend',()=>resetHide());
resetHide();
// drag to switch dock top/bottom
let dragY=null;
drag.addEventListener('mousedown',e=>{dragY=e.clientY; drag.style.cursor='grabbing'; e.preventDefault();});
document.addEventListener('mouseup',()=>{dragY=null; drag.style.cursor='grab';});
document.addEventListener('mousemove',e=>{if(dragY==null) return; const toTop=e.clientY<innerHeight/2; hud.classList.toggle('top',toTop); hud.classList.toggle('bottom',!toTop);});

/* ---------- motion ---------- */
function setMode(m){mode=m; if(autoTimer){clearInterval(autoTimer);autoTimer=null;}}
function auto(){if(autoTimer) return; const seq=['orbit','pulse','alpha','omega','vortex']; let i=0; mode=seq[i]; autoTimer=setInterval(()=>{i=(i+1)%seq.length; mode=seq[i];},6500);}
function focusAt(tt){const cx=1.5,cy=0.4,rx=2.5,ry=1.5;
  if(mode==='alpha') return {x: DOMAIN.xmin + ((tt*0.6)%(DOMAIN.xmax-DOMAIN.xmin)), y: 0.25*Math.sin(tt*0.9)};
  if(mode==='omega') return {x: 0.25*Math.sin(tt*0.9), y: DOMAIN.ymin + ((tt*0.6)%(DOMAIN.ymax-DOMAIN.ymin))};
  if(mode==='vortex'){const k=Math.max(0.55, Math.cos(tt*0.25)); return {x:cx+k*rx*Math.cos(tt), y:cy+k*ry*Math.sin(tt)};}
  return {x:cx+rx*Math.cos(tt), y:cy+ry*Math.sin(tt)};}
function radiusAt(tt){let r=parseFloat(radius.value)||1.35; if(mode==='pulse') r*= (0.78 + 0.35*Math.sin(tt*1.25)); if(burstTimer>0) r*=1.15; return r;}

/* ---------- backdrop stars ---------- */
const stars=[...Array(120)].map(()=>({x:Math.random()*W,y:Math.random()*H,a:0.15+Math.random()*0.25}));
function paintStars(){ctx.save(); ctx.fillStyle='rgba(255,255,255,.06)'; for(const s of stars){ctx.globalAlpha=s.a; ctx.fillRect(s.x,s.y,1.2,1.2);} ctx.restore();}

/* ---------- small helper for Alpha pill ---------- */
function pill(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

/* ---------- axes (Omega + Alpha pill) ---------- */
function drawAxes(tt){
  if(!showAxesEl.checked) return;

  const pulseR=0.55+0.45*Math.sin(tt*0.9), pulseB=0.55+0.45*Math.sin(tt*0.9+Math.PI/3);

  // Alpha horizontal line
  let [ax1,ay]=toPX(DOMAIN.xmin,0), [ax2]=toPX(DOMAIN.xmax,0);
  ctx.strokeStyle=`rgba(255,77,77,${0.45+0.35*pulseR})`;
  ctx.shadowColor=`rgba(255,77,77,${0.6*pulseR})`;
  ctx.shadowBlur=(6+10*pulseR); ctx.lineWidth=(1.6+0.8*pulseR);
  ctx.beginPath(); ctx.moveTo(ax1,ay); ctx.lineTo(ax2,ay); ctx.stroke(); ctx.shadowBlur=0;

  // Omega vertical line + label (left)
  let [ox,oy1]=toPX(0,DOMAIN.ymin), [,oy2]=toPX(0,DOMAIN.ymax);
  ctx.strokeStyle=`rgba(77,166,255,${0.45+0.35*pulseB})`;
  ctx.shadowColor=`rgba(77,166,255,${0.6*pulseB})`;
  ctx.shadowBlur=(6+10*pulseB); ctx.lineWidth=(1.6+0.8*pulseB);
  ctx.beginPath(); ctx.moveTo(ox,oy1); ctx.lineTo(ox,oy2); ctx.stroke(); ctx.shadowBlur=0;
  ctx.save(); ctx.translate(14, H/2+40); ctx.rotate(-Math.PI/2);
  ctx.fillStyle="#4da6ff"; ctx.font="14px system-ui"; ctx.fillText("Omega",0,0); ctx.restore();

  // Alpha label as a bottom-right glowing pill (always readable)
  const label="Alpha";
  ctx.save();
  ctx.font="bold 15px system-ui";
  const padX=10, padY=6, tw=ctx.measureText(label).width;
  const bx=W - (tw + padX*2) - 14;   // right margin
  const by=H - (15 + padY*2);        // bottom margin

  ctx.globalAlpha=0.9;
  ctx.fillStyle="rgba(8,12,20,0.76)"; // dark translucent pill
  pill(ctx,bx,by,tw+padX*2,20+padY*2,10); ctx.fill();

  ctx.strokeStyle="rgba(255,102,102,0.7)";
  ctx.lineWidth=1; ctx.shadowColor="rgba(255,60,60,0.85)"; ctx.shadowBlur=8;
  pill(ctx,bx,by,tw+padX*2,20+padY*2,10); ctx.stroke();

  ctx.shadowBlur=0; ctx.fillStyle="#ff6666";
  ctx.fillText(label, bx+padX, by+20+padY-4);
  ctx.restore();
}

/* ---------- main loop ---------- */
function loop(){requestAnimationFrame(loop);
  if(playing) t += (parseFloat(speed.value)||0.36)*0.03;
  ctx.clearRect(0,0,W,H); paintStars(); drawAxes(t);

  const focus=focusAt(t);
  const R=radiusAt(t), R2=R*R, Rinv=1/(R+1e-6);
  const burstStrength=parseFloat(burstEl.value)||0.7;

  // gather inside
  let inside=[]; for(let i=0;i<points.length;i++){const p=points[i]; const dx=p.x-focus.x, dy=p.y-focus.y; if(dx*dx+dy*dy<=R2) inside.push(i);}

  // auto burst
  if(inside.length >= (parseInt(densEl.value)||150)) burstTimer=Math.max(burstTimer, 0.55+0.002*inside.length);

  // repulsion + pull
  const kN = Math.max(6, Math.min(24, Math.floor(0.015*inside.length)));
  for(const ii of inside){
    const p=points[ii];
    const dxf=p.x-focus.x, dyf=p.y-focus.y, df2=dxf*dxf+dyf*dyf+1e-6;
    const pull = 0.012*(Rinv)*Math.sqrt(df2); p.vx += -dxf*pull; p.vy += -dyf*pull;
    for(let k=0;k<kN;k++){
      const jj=inside[(Math.random()*inside.length)|0]; if(jj===ii) continue;
      const q=points[jj]; let dx=p.x-q.x, dy=p.y-q.y, d2=dx*dx+dy*dy + 1e-5;
      const f=0.0010*burstStrength*(1/d2); p.vx += dx*f; p.vy += dy*f;
    }
  }

  // burst kick
  if(burstTimer>0){
    const kick=0.06*burstStrength*burstTimer;
    for(const ii of inside){
      const p=points[ii]; const dx=p.x-focus.x, dy=p.y-focus.y, d=Math.hypot(dx,dy)+1e-6;
      p.vx += (dx/d)*kick*(0.7+0.6*Math.random()); p.vy += (dy/d)*kick*(0.7+0.6*Math.random());
      if(secureEl.checked){p.lastFx=focus.x; p.lastFy=focus.y; p.trail=1.0;}
    }
    burstTimer=Math.max(0, burstTimer-0.03);
  }

  // integrate + diffuse cloud
  ctx.save(); ctx.globalAlpha=0.18; ctx.fillStyle="#ffd166";
  for(const p of points){p.vx*=0.92; p.vy*=0.92; p.x+=p.vx; p.y+=p.vy; const [px,py]=toPX(p.x,p.y); ctx.fillRect(px,py,2,2);} ctx.restore();

  // trails
  if(secureEl.checked){
    ctx.save();
    for(const p of points){
      if(p.trail>0 && p.lastFx!=null){
        const [x1,y1]=toPX(p.x,p.y), [x2,y2]=toPX(p.lastFx,p.lastFy);
        const a=Math.max(0, Math.min(0.35, p.trail*0.35));
        ctx.strokeStyle=`rgba(93,211,255,${a})`; ctx.lineWidth=1.2;
        ctx.beginPath(); ctx.moveTo(x1,y1);
        const cx=(x1+x2)/2 + 18*(Math.random()-0.5), cy=(y1+y2)/2 + 18*(Math.random()-0.5);
        ctx.quadraticCurveTo(cx,cy,x2,y2); ctx.stroke();
        p.trail-=0.04; if(p.trail<=0){p.lastFx=null;p.lastFy=null;}
      }
    }
    ctx.restore();
  }

  // collapsed points
  ctx.save(); ctx.globalAlpha=0.92; ctx.fillStyle="#5dd3ff";
  for(const ii of inside){const p=points[ii]; const [px,py]=toPX(p.x,p.y); ctx.beginPath(); ctx.arc(px,py,2.3,0,Math.PI*2); ctx.fill();
    if(Math.random()<0.12){const [fx,fy]=toPX(focus.x,focus.y); ctx.globalAlpha=0.25; ctx.strokeStyle="#5dd3ff"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(fx,fy); ctx.stroke(); ctx.globalAlpha=0.92;}
  } ctx.restore();

  // focus lens
  const [fx,fy]=toPX(focus.x,focus.y);
  const pulse=0.5+0.5*Math.sin(t*1.1+Math.PI/6)+0.25*burstTimer;
  ctx.save();
  ctx.lineWidth=(1.6+1.4*pulse); ctx.setLineDash([8,6]);
  ctx.strokeStyle=`rgba(207,214,230,${0.45+0.35*pulse})`;
  ctx.shadowColor=`rgba(93,211,255,${0.6*pulse})`; ctx.shadowBlur=(6+16*pulse);
  ctx.beginPath(); ctx.arc(fx,fy,R*SCALE,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
  const g=ctx.createRadialGradient(fx,fy,0,fx,fy,R*SCALE);
  g.addColorStop(0,`rgba(93,211,255,${0.12+0.10*pulse})`); g.addColorStop(1,'rgba(93,211,255,0)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(fx,fy,R*SCALE,0,Math.PI*2); ctx.fill(); ctx.restore();
}
loop();

/* ---------- export ---------- */
let rec=null, chunks=[];
function record(){ if(rec) return; const s=canvas.captureStream(30);
  rec=new MediaRecorder(s,{mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9')?'video/webm;codecs=vp9':'video/webm;codecs=vp8'});
  rec.ondataavailable=e=>{if(e.data.size) chunks.push(e.data);};
  rec.onstop=()=>{const blob=new Blob(chunks,{type:'video/webm'}), url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='ethryx-emasai.webm'; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0); rec=null; chunks=[];};
  rec.start(); setTimeout(()=>{if(rec) rec.stop();},6000);
}
</script>
</body>
</html>
